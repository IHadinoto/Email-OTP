# Email OTP Module

## Task

1\. **Implement a Secure Email OTP Module**: Develop a module that can generate and send OTPs via email for authentication purposes in an enterprise application. You are free to use any standard library in the language of your choice.

2\. **Document Assumptions**: Clearly document any assumptions you make during the implementation.

3\. **Describe Testing Methodology**: Provide a detailed explanation of how you would test your module.

## Assumptions

- The `send_email(email_address, email_body)` function is implemented and can be used to send emails.

- Only email addresses from the `dso.org.sg` domain are allowed to receive OTP codes.

- OTPs are valid for 1 minute.

- The OTP is a 6-digit random number.

- The module allows the user 10 attempts to enter the correct OTP before failing.

## Pseudo Code

```pseudo

Class Email_OTP_Module {

    /* start can be called after an instance of Email OTP is constructed. Can be used to initialise variables.

     */

    function start() {

        //optional to implement

    }

    /* close can be called after an instance of Email OTP is to be removed from the application.

     */

    function close() {

        //optional to implement

    }

    /*

    @func generate_OTP_email sends a new 6-digit random OTP code to the given email address input by the users. Only emails from the ".dso.org.sg" domain should be allowed to receive an OTP code.

    You can assume a function send_email(email_address, email_body) is implemented. 

    Email body to the user should be in this format "Your OTP Code is 123456. The code is valid for 1 minute"

    @param user_email is an email address entered by the user.

    @returns the following status codes (assume implemented as constants):

    STATUS_EMAIL_OK: email containing OTP has been sent successfully.

    STATUS_EMAIL_FAIL: email address does not exist or sending to the email has failed.

    STATUS_EMAIL_INVALID: email address is invalid.

    */  

    function generate_OTP_email(string user_email) {

        //implement me

    }

    /*

    @func check_OTP reads the input stream for user input of the OTP. The OTP to match is the current OTP generated by a send.

    Allows user 10 tries to enter the valid OTP. check_OTP should return after 1 minute if the user does not give a valid OTP.

    @param input is a generic IOstream. It implements input.readOTP() which waits and returns the 6-digit entered by the user. this function call is blocking so you might need to wrap it in a timeout.

    @returns the following status codes (assume implemented as constants):

    STATUS_OTP_OK: OTP is valid and checked.

    STATUS_OTP_FAIL: OTP is wrong after 10 tries.

    STATUS_OTP_TIMEOUT: timeout after 1 minute.

    */

    function check_OTP(iostream input) {

        //implement me

    }

}

```

## Implementation Plan

### Step 1: Define the Email_OTP_Module Class

- **start()**: Optionally initialize variables.

- **close()**: Optionally clean up resources.

- **generate_OTP_email(user_email)**: Generate a 6-digit OTP, validate the email address, and send the OTP email.

- **check_OTP(input)**: Read the OTP input from the user, validate the OTP, and handle timeouts and retry limits.

### Step 2: Implement Helper Functions

- **GenerateOTP()**: Generate a 6-digit random OTP.

- **ValidateEmailDomain(email)**: Check if the email belongs to the `dso.org.sg` domain.

- **SendEmail(emailAddress, emailBody)**: Send the OTP email using the implemented `send_email` function.

### Step 3: Test the Module

- **Unit Tests**: Create unit tests for each function to verify they work as expected.

- **Integration Tests**: Test the module in the context of your application to ensure proper interaction with other components.

- **Mocking**: Use mocking frameworks to simulate email sending without actually sending emails.

- **Edge Cases**: Ensure edge cases are handled, such as invalid email formats, multiple consecutive OTP requests, and handling of timeout scenarios.

### Example Code

Here's a skeleton implementation in C#:

```csharp

using System;

using System.IO;

using System.Net.Mail;

public class Email_OTP_Module

{

    private const string DOMAIN = "@dso.org.sg";

    private const int OTP_LENGTH = 6;

    private const int OTP_VALIDITY_DURATION = 60000; // 1 minute in milliseconds

    private const int MAX_OTP_ATTEMPTS = 10;

    private string currentOTP;

    private DateTime otpGeneratedTime;

    private int otpAttempts;

    public void start()

    {

        // Initialize variables if necessary

    }

    public void close()

    {

        // Clean up resources if necessary

    }

    private string GenerateOTP()

    {

        Random random = new Random();

        string otp = random.Next(0, 999999).ToString("D6");

        return otp;

    }

    private bool ValidateEmailDomain(string email)

    {

        return email.EndsWith(DOMAIN, StringComparison.OrdinalIgnoreCase);

    }

    private bool SendEmail(string emailAddress, string emailBody)

    {

        try

        {

            // Assuming send_email is defined elsewhere

            send_email(emailAddress, emailBody);

            return true;

        }

        catch (Exception)

        {

            return false;

        }

    }

    public int generate_OTP_email(string user_email)

    {

        if (!Regex.IsMatch(user_email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$") || !ValidateEmailDomain(user_email))

        {

            return STATUS_EMAIL_INVALID;

        }

        currentOTP = GenerateOTP();

        otpGeneratedTime = DateTime.Now;

        otpAttempts = 0;

        string emailBody = $"Your OTP Code is {currentOTP}. The code is valid for 1 minute";

        return SendEmail(user_email, emailBody) ? STATUS_EMAIL_OK : STATUS_EMAIL_FAIL;

    }

    public int check_OTP(TextReader input)

    {

        var cts = new CancellationTokenSource(OTP_VALIDITY_DURATION);

        var token = cts.Token;

        while (otpAttempts < MAX_OTP_ATTEMPTS && (DateTime.Now - otpGeneratedTime).TotalMilliseconds < OTP_VALIDITY_DURATION)

        {

            try

            {

                string userInput = Task.Run(() => input.ReadLine(), token).Result;

                if (userInput == currentOTP) return STATUS_OTP_OK;

                otpAttempts++;

            }

            catch (OperationCanceledException)

            {

                return STATUS_OTP_TIMEOUT;

            }

        }

        return otpAttempts >= MAX_OTP_ATTEMPTS ? STATUS_OTP_FAIL : STATUS_OTP_TIMEOUT;

    }

    private void send_email(string emailAddress, string emailBody)

    {

        using (var client = new SmtpClient("smtp.yourserver.com"))

        {

            var mail = new MailMessage("your-email@dso.org.sg", emailAddress)

            {

                Subject = "Your OTP Code",

                Body = emailBody

            };

            client.Send(mail);

        }

    }

    public const int STATUS_EMAIL_OK = 0;

    public const int STATUS_EMAIL_FAIL = 1;

    public const int STATUS_EMAIL_INVALID = 2;

    public const int STATUS_OTP_OK = 3;

    public const int STATUS_OTP_FAIL = 4;

    public const int STATUS_OTP_TIMEOUT = 5;

}

```

## Testing Methodology

### Unit Tests

- Validate email addresses.

- Generate and send OTP.

- Check OTP input.

- Handle timeouts and retry limits.

### Integration Tests

- Ensure interaction with the application's components.

- Mock email sending to avoid actual email dispatch.

### Edge Cases

- Multiple consecutive OTP requests.

- Immediate invalid attempts after OTP generation.

- Invalid email formats and domains.

## Example Main Function in Program.cs

```csharp

using System;

using System.IO;

namespace OTPModuleApp

{

    class Program

    {

        static void Main(string[] args)

        {

            Email_OTP_Module otpModule = new Email_OTP_Module();

            otpModule.start();

            Console.WriteLine("Enter your email address (only @dso.org.sg domain is allowed):");

            string userEmail = Console.ReadLine();

            int emailStatus = otpModule.generate_OTP_email(userEmail);

            if (emailStatus == Email_OTP_Module.STATUS_EMAIL_OK)

            {

                Console.WriteLine("OTP has been sent to your email. Please check your email and enter the OTP below:");

            }

            else

            {

                Console.WriteLine("Email error: " + (emailStatus == Email_OTP_Module.STATUS_EMAIL_INVALID ? "Invalid email" : "Failed to send email"));

                otpModule.close();

                return;

            }

            using (StringReader reader = new StringReader(Console.ReadLine()))

            {

                int otpStatus = otpModule.check_OTP(reader);

                Console.WriteLine(otpStatus == Email_OTP_Module.STATUS_OTP_OK ? "OTP is valid and checked."

                              : otpStatus == Email_OTP_Module.STATUS_OTP_FAIL ? "Failed to enter valid OTP after 10 tries."

                              : "OTP entry timed out after 1 minute.");

            }

            otpModule.close();

        }

    }

}

```

---

This README provides a comprehensive guide to setting up, implementing, and testing your Email OTP module. If you need further assistance or have any questions, feel free to ask me.
